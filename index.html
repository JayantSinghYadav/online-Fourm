<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spidy's World Chat â€” FOURM</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
  <div class="app" role="application">
    <div class="left">
      <div class="header">
        <div class="logo">ðŸ’¬</div>
        <div>
          <div class="title">Spidy's World Chat â€” FOURM</div>
          <div class="sub">Messages sync across devices in real time</div>
        </div>
      </div>

      <div id="messages" class="messages" aria-live="polite"></div>

      <div style="display:flex;gap:12px;align-items:flex-end">
        <div style="flex:1">
          <div class="composer">
            <textarea id="messageInput" placeholder="Type a message... (Shift+Enter = newline)" aria-label="Message"></textarea>
            <button id="sendBtn" class="btn">Send</button>
          </div>
        </div>
        <div class="controls">
          <button id="adminBtn" class="ghost" title="Admin Panel" style="background:#7dd3fc;color:#012;font-weight:600;">Admin</button>
          <button id="clearBtn" class="ghost" title="Clear all messages">Clear</button>
          <button id="exportBtn" class="ghost" title="Export messages">Export</button>
        </div>
      </div>
    </div>

    <aside class="right">
      <div class="panel">
        <div class="section-title">Your guest identity</div>
        <div class="guest">
          <div class="avatar" id="myAvatar">G</div>
          <input id="guestName" maxlength="24" />
        </div>
        <div class="small" style="margin-top:8px">Your name is saved only in this browser. Change it anytime.</div>
      </div>

      <div class="panel">
        <div class="section-title">Online Users</div>
        <div style="font-size:24px;font-weight:700;color:var(--accent);" id="onlineCount">0</div>
        <div class="small">Users currently online</div>
      </div>

      <div class="panel">
        <div class="section-title">How it works</div>
        <div class="small">Join telegram for updates.</div>
      </div>
    </aside>
  </div>

  <div id="adminPanel" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;align-items:center;justify-content:center;">
    <div style="background:linear-gradient(180deg, #0b1220, #071021);border-radius:12px;padding:24px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
        <h2 style="margin:0;color:var(--accent);">Admin Panel</h2>
        <button id="closeAdmin" style="background:transparent;border:none;color:#fff;font-size:24px;cursor:pointer;">&times;</button>
      </div>
      
      <div id="adminContent">
        <div style="margin-bottom:20px;">
          <button id="viewUsersBtn" class="btn" style="width:100%;margin-bottom:10px;">View Online Users</button>
          <button id="viewSeenBtn" class="btn" style="width:100%;background:#6366f1;">Check Message Seen</button>
        </div>
        
        <div id="usersList" style="display:none;margin-top:20px;">
          <h3 style="color:var(--accent);margin-bottom:10px;">Online Users</h3>
          <div id="usersContent"></div>
        </div>
        
        <div id="seenPanel" style="display:none;margin-top:20px;">
          <h3 style="color:var(--accent);margin-bottom:10px;">Message Seen Status</h3>
          <input type="number" id="msgIdInput" placeholder="Enter message ID" style="width:100%;padding:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#fff;margin-bottom:10px;">
          <button id="checkSeenBtn" class="btn" style="width:100%;">Check Who Seen</button>
          <div id="seenContent" style="margin-top:15px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const socket = io();
    let allMessages = [];

    // Elements
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const clearBtn = document.getElementById("clearBtn");
    const exportBtn = document.getElementById("exportBtn");
    const guestNameEl = document.getElementById("guestName");
    const myAvatarEl = document.getElementById("myAvatar");
    const onlineCountEl = document.getElementById("onlineCount");

    // Guest name
    function randomGuest() {
      return "Guest" + Math.floor(Math.random() * 9000 + 100);
    }
    let myName = localStorage.getItem("guest-name") || randomGuest();
    guestNameEl.value = myName;
    myAvatarEl.textContent = nameToInitial(myName);

    guestNameEl.addEventListener("change", () => {
      let newName = guestNameEl.value.trim() || randomGuest();
      myName = newName;
      localStorage.setItem("guest-name", myName);
      myAvatarEl.textContent = nameToInitial(myName);
      socket.emit('update_username', { name: myName });
    });

    function nameToInitial(name) {
      return name.trim().split(" ").map(s => s[0]?.toUpperCase()).slice(0, 2).join("") || "G";
    }

    // Render message
    function renderMessage(m) {
      const el = document.createElement("div");
      el.className = "msg";

      const avatar = document.createElement("div");
      avatar.className = "avatar";
      avatar.textContent = nameToInitial(m.name);

      const bubble = document.createElement("div");
      bubble.className = "bubble";

      const meta = document.createElement("div");
      meta.className = "meta";
      meta.textContent = m.name + " â€¢ " + new Date(m.ts).toLocaleString() + (m.id !== undefined ? ` â€¢ ID:${m.id}` : '');

      const text = document.createElement("div");
      text.className = "text";
      text.textContent = m.text;

      bubble.appendChild(meta);
      bubble.appendChild(text);

      el.appendChild(avatar);
      el.appendChild(bubble);

      messagesEl.appendChild(el);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Socket events
    socket.on('all_messages', (messages) => {
      allMessages = messages;
      messagesEl.innerHTML = "";
      messages.forEach(m => {
        renderMessage(m);
        if (m.id !== undefined) {
          socket.emit('mark_seen', { msg_id: m.id, username: myName });
        }
      });
    });

    socket.on('new_message', (message) => {
      allMessages.push(message);
      renderMessage(message);
      setTimeout(() => {
        socket.emit('mark_seen', { msg_id: message.id, username: myName });
      }, 500);
    });

    socket.on('messages_cleared', () => {
      allMessages = [];
      messagesEl.innerHTML = "";
    });

    socket.on('user_count', (count) => {
      onlineCountEl.textContent = count;
    });

    socket.on('clear_failed', (data) => {
      alert('Failed to clear messages: ' + data.error);
    });

    socket.on('user_kicked', (data) => {
      console.log('User kicked:', data.sid);
    });

    // Admin panel
    let adminPassword = null;
    const adminPanel = document.getElementById('adminPanel');
    const adminBtn = document.getElementById('adminBtn');
    const closeAdmin = document.getElementById('closeAdmin');
    const viewUsersBtn = document.getElementById('viewUsersBtn');
    const viewSeenBtn = document.getElementById('viewSeenBtn');
    const usersList = document.getElementById('usersList');
    const seenPanel = document.getElementById('seenPanel');
    const checkSeenBtn = document.getElementById('checkSeenBtn');

    adminBtn.addEventListener('click', () => {
      if (!adminPassword) {
        const pass = prompt('Enter admin password:');
        if (!pass) return;
        socket.emit('admin_login', { password: pass });
        adminPassword = pass;
      } else {
        adminPanel.style.display = 'flex';
      }
    });

    closeAdmin.addEventListener('click', () => {
      adminPanel.style.display = 'none';
      usersList.style.display = 'none';
      seenPanel.style.display = 'none';
    });

    socket.on('admin_login_success', () => {
      adminPanel.style.display = 'flex';
    });

    socket.on('admin_login_failed', (data) => {
      alert('Admin login failed: ' + data.error);
      adminPassword = null;
    });

    viewUsersBtn.addEventListener('click', () => {
      socket.emit('get_online_users', { password: adminPassword });
      seenPanel.style.display = 'none';
    });

    socket.on('online_users_list', (users) => {
      usersList.style.display = 'block';
      const usersContent = document.getElementById('usersContent');
      usersContent.innerHTML = '';
      users.forEach(user => {
        const userDiv = document.createElement('div');
        userDiv.style.cssText = 'background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;margin-bottom:8px;display:flex;justify-content:space-between;align-items:center;';
        userDiv.innerHTML = `
          <div>
            <div style="font-weight:600;color:var(--accent);">${user.name}</div>
            <div style="font-size:11px;color:var(--muted);">Connected: ${new Date(user.connected_at).toLocaleString()}</div>
          </div>
          <button onclick="kickUser('${user.sid}')" class="ghost" style="background:#ef4444;color:#fff;padding:6px 12px;">Kick</button>
        `;
        usersContent.appendChild(userDiv);
      });
    });

    window.kickUser = (sid) => {
      if (confirm('Are you sure you want to kick this user?')) {
        socket.emit('kick_user', { password: adminPassword, sid: sid });
      }
    };

    viewSeenBtn.addEventListener('click', () => {
      seenPanel.style.display = 'block';
      usersList.style.display = 'none';
    });

    checkSeenBtn.addEventListener('click', () => {
      const msgId = parseInt(document.getElementById('msgIdInput').value);
      if (isNaN(msgId)) {
        alert('Please enter a valid message ID');
        return;
      }
      socket.emit('get_message_seen', { password: adminPassword, msg_id: msgId });
    });

    socket.on('message_seen_info', (data) => {
      const seenContent = document.getElementById('seenContent');
      seenContent.innerHTML = `
        <div style="background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;">
          <div style="margin-bottom:8px;"><strong>Message #${data.msg_id}:</strong> ${data.message}</div>
          <div><strong>Seen by:</strong> ${data.seen_by.length > 0 ? data.seen_by.join(', ') : 'No one yet'}</div>
        </div>
      `;
    });

    // Send message
    function sendMessage() {
      const raw = inputEl.value.trim();
      if (!raw) return;
      socket.emit('send_message', { name: myName, text: raw });
      inputEl.value = "";
      inputEl.focus();
    }

    sendBtn.addEventListener("click", sendMessage);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Clear chat
    clearBtn.addEventListener("click", () => {
      const password = prompt("Enter password to clear all messages:");
      if (!password) return;
      socket.emit('clear_messages', { password: password });
    });

    // Export messages
    exportBtn.addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(allMessages, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "chat-messages.json";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    // Focus input on load
    inputEl.focus();
  </script>
  <script>
const socket = io();

const nameInput = document.getElementById("guestName");
const sendBtn = document.getElementById("sendBtn");
const messageInput = document.getElementById("messageInput");

let username = localStorage.getItem("chatUsername");

// Disable send until name is set
if (!username) {
  sendBtn.disabled = true;
  messageInput.disabled = true;
} else {
  nameInput.value = username;
}

// When user types a name
nameInput.addEventListener("change", () => {
  const newName = nameInput.value.trim();
  if (newName.length > 0) {
    username = newName;
    localStorage.setItem("chatUsername", username);
    sendBtn.disabled = false;
    messageInput.disabled = false;
  }
});

// Send message
sendBtn.addEventListener("click", () => {
  const text = messageInput.value.trim();
  if (!username) {
    alert("Please set your name before chatting!");
    return;
  }
  if (text.length > 0) {
    socket.emit("message", { user: username, text });
    messageInput.value = "";
  }
});

// Display messages
socket.on("message", (data) => {
  const msgDiv = document.createElement("div");
  msgDiv.classList.add("message");
  msgDiv.innerHTML = `<strong>${data.user}:</strong> ${data.text}`;
  document.getElementById("messages").appendChild(msgDiv);
  msgDiv.scrollIntoView();
});
</script>
</body>
</html>
